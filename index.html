<!DOCTYPE html>
<html lang="en" dir="ltr" id="htmlTag">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>V Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --dark-black: #121212;
      --bright-white: #f8f9fa;
      --dark-orange: #d2691e;
      --dark-green: #013220;
      --red: #b22222;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: var(--dark-black);
      color: var(--bright-white);
      min-height: 100vh;
      padding: 20px;
    }
    .screen {
      display: none;
      animation: fadeIn 0.4s ease;
    }
    .screen.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
      transition: all 0.2s;
    }
    .btn-primary { background-color: var(--dark-orange); color: white; }
    .btn-success { background-color: var(--dark-green); color: white; }
    .btn-danger { background-color: var(--red); color: white; }
    .btn-link {
      background: none;
      color: var(--dark-orange);
      text-decoration: underline;
      border: none;
      cursor: pointer;
      padding: 0;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #444;
      background: #1e1e1e;
      color: white;
    }
    .form-container {
      max-width: 400px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 12px;
    }
    .chat-container {
      max-width: 900px;
      margin: 20px auto;
      display: flex;
      flex-direction: column;
      height: 85vh;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #1a1a1a;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .friends-list {
      width: 250px;
      background: #1a1a1a;
      border-radius: 10px;
      padding: 10px;
      overflow-y: auto;
      max-height: 70vh;
    }
    .chat-area {
      flex: 1;
      background: #1a1a1a;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
    }
    .messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      max-width: 70%;
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 12px;
      word-wrap: break-word;
    }
    .sent { background-color: var(--dark-orange); align-self: flex-end; }
    .received { background-color: #333; align-self: flex-start; }
    .input-area {
      display: flex;
      padding: 10px;
      background: #1a1a1a;
      border-top: 1px solid #333;
    }
    .input-area input {
      flex: 1;
      margin: 0 10px 0 0;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .friend-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #333;
      cursor: pointer;
    }
    .requests-list {
      position: absolute;
      top: 60px;
      right: 20px;
      background: #1a1a1a;
      border-radius: 10px;
      padding: 15px;
      width: 280px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 10;
      display: none;
    }
    .request-item {
      padding: 10px 0;
      border-bottom: 1px solid #333;
    }
    .lang-btn {
      padding: 15px;
      font-size: 18px;
      width: 45%;
      margin: 10px;
    }
    .error { color: var(--red); }
    .success { color: var(--dark-green); }
    .center { text-align: center; }
    .rtl .messages { align-items: flex-end; }
    .rtl .sent { align-self: flex-start; }
    .rtl .received { align-self: flex-end; }
    .rtl .input-area input { margin: 0 0 0 10px; }
    .rtl .friend-item { flex-direction: row-reverse; }
    .rtl .friend-item .avatar { margin-left: 10px; margin-right: 0; }
  </style>
</head>
<body>

<div id="inScreen" class="screen active">
  <div class="form-container center">
    <h2>V Chat</h2>
    <button class="btn btn-primary lang-btn" onclick="setLanguage('ar')">العربية</button>
    <button class="btn btn-primary lang-btn" onclick="setLanguage('en')">English</button>
  </div>
</div>

<div id="sgnScreen" class="screen">
  <div class="form-container">
    <h2 id="sgnTitle">Sign In / Sign Up</h2>
    <button class="btn btn-primary" onclick="showScreen('crsgnScreen')"><span id="btnCreate">Create Account</span></button>
    <button class="btn btn-success" onclick="showScreen('rrsgnScreen')"><span id="btnLogin">Login</span></button>
  </div>
</div>

<div id="crsgnScreen" class="screen">
  <div class="form-container">
    <h2 id="crsgnTitle">Create Account</h2>
    <input type="text" id="crName" placeholder="Name" />
    <input type="number" id="crAge" placeholder="Age" min="12" />
    <input type="password" id="crPass" placeholder="Password" />
    <input type="password" id="crPass2" placeholder="Confirm Password" />
    <p id="savePassNote">Please save your password securely.</p>
    <button class="btn btn-primary" onclick="createAccount()"><span id="btnCreateNow">Create Now</span></button>
    <button class="btn-link" onclick="showScreen('sgnScreen')"><span id="haveAccount">I already have an account</span></button>
  </div>
</div>

<div id="rrsgnScreen" class="screen">
  <div class="form-container">
    <h2 id="rrsgnTitle">Login</h2>
    <input type="text" id="rrName" placeholder="Name" />
    <input type="password" id="rrPass" placeholder="Password" />
    <button class="btn btn-success" onclick="login()"><span id="btnLoginNow">Login Now</span></button>
    <div style="margin-top: 15px;">
      <button class="btn-link" onclick="forgotPassword()"><span id="forgotPass">Forgot Password?</span></button><br/>
      <button class="btn-link" onclick="showScreen('crsgnScreen')"><span id="newAccount">Create New Account</span></button>
    </div>
  </div>
</div>

<div id="mainScreen" class="screen">
  <div class="top-bar">
    <div>
      <span id="currentUserName">User</span>
      <img id="currentUserAvatar" class="avatar" src="" alt="Avatar" />
    </div>
    <div>
      <button class="btn btn-primary" onclick="showAddFriend()"><i class="fas fa-comment"></i></button>
      <button class="btn btn-success" onclick="toggleRequests()"><i class="fas fa-arrow-left"></i></button>
      <button class="btn btn-danger" onclick="contactDev()"><span id="contactDevBtn">Talk to Developer</span></button>
    </div>
  </div>

  <div class="chat-container">
    <div class="friends-list" id="friendsList"></div>
    <div class="chat-area">
      <div class="messages" id="messagesBox"></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)" />
        <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <div class="requests-list" id="requestsBox"></div>
</div>

<div id="addFriendModal" class="screen" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100;">
  <div class="form-container" style="max-width:400px;margin:150px auto;">
    <h3 id="addFriendTitle">Add Friend</h3>
    <input type="text" id="friendNameInput" placeholder="Enter friend's name" />
    <div id="addFriendStatus"></div>
    <button class="btn btn-primary" onclick="sendFriendRequest()"><span id="sendRequestBtn">Send Request</span></button>
    <button class="btn btn-danger" onclick="document.getElementById('addFriendModal').style.display='none'">Close</button>
  </div>
</div>

<div id="genderScreen" class="screen" style="display:none;text-align:center;padding-top:100px;">
  <h2 id="genderQuestion">What is your gender?</h2><br/>
  <button class="btn btn-primary" onclick="setGender('male')" style="margin:10px;">Male</button>
  <button class="btn btn-primary" onclick="setGender('female')" style="margin:10px;">Female</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    doc,
    setDoc,
    getDoc,
    deleteDoc,
    onSnapshot,
    serverTimestamp,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAWu_lp000q1ZT_VGcFoP97CZkJXKsdnVQ",
    authDomain: "vchat-c0232.firebaseapp.com",
    projectId: "vchat-c0232",
    storageBucket: "vchat-c0232.firebasestorage.app",
    messagingSenderId: "1019888720035",
    appId: "1:1019888720035:web:005ef386fd5306ee5e8716",
    measurementId: "G-K203686D8T"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentChatUser = null;
  let currentChatId = null;

  const translations = {
    ar: {
      sgnTitle: "تسجيل الدخول / إنشاء حساب",
      btnCreate: "إنشاء حساب",
      btnLogin: "تسجيل الدخول",
      crsgnTitle: "إنشاء حساب",
      savePassNote: "يرجى حفظ كلمة المرور الخاصة بك بشكل آمن.",
      btnCreateNow: "إنشاء الآن",
      haveAccount: "لدي حساب بالفعل",
      rrsgnTitle: "تسجيل الدخول",
      btnLoginNow: "تسجيل الدخول الآن",
      forgotPass: "نسيت كلمة المرور؟",
      newAccount: "إنشاء حساب جديد",
      contactDevBtn: "تحدث مع المطور",
      addFriendTitle: "إضافة صديق",
      sendRequestBtn: "إرسال الطلب",
      genderQuestion: "ما هو نوعك؟",
      male: "ذكر",
      female: "أنثى"
    },
    en: {
      sgnTitle: "Sign In / Sign Up",
      btnCreate: "Create Account",
      btnLogin: "Login",
      crsgnTitle: "Create Account",
      savePassNote: "Please save your password securely.",
      btnCreateNow: "Create Now",
      haveAccount: "I already have an account",
      rrsgnTitle: "Login",
      btnLoginNow: "Login Now",
      forgotPass: "Forgot Password?",
      newAccount: "Create New Account",
      contactDevBtn: "Talk to Developer",
      addFriendTitle: "Add Friend",
      sendRequestBtn: "Send Request",
      genderQuestion: "What is your gender?",
      male: "Male",
      female: "Female"
    }
  };

  function setLanguage(lang) {
    localStorage.setItem('vchat_lang', lang);
    document.getElementById('htmlTag').dir = lang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('htmlTag').lang = lang;
    updateTexts(lang);
    showScreen('sgnScreen');
  }

  function getLang() {
    return localStorage.getItem('vchat_lang') || 'en';
  }

  function updateTexts(lang) {
    const t = translations[lang];
    document.getElementById('sgnTitle').textContent = t.sgnTitle;
    document.getElementById('btnCreate').textContent = t.btnCreate;
    document.getElementById('btnLogin').textContent = t.btnLogin;
    document.getElementById('crsgnTitle').textContent = t.crsgnTitle;
    document.getElementById('savePassNote').textContent = t.savePassNote;
    document.getElementById('btnCreateNow').textContent = t.btnCreateNow;
    document.getElementById('haveAccount').textContent = t.haveAccount;
    document.getElementById('rrsgnTitle').textContent = t.rrsgnTitle;
    document.getElementById('btnLoginNow').textContent = t.btnLoginNow;
    document.getElementById('forgotPass').textContent = t.forgotPass;
    document.getElementById('newAccount').textContent = t.newAccount;
    document.getElementById('contactDevBtn').textContent = t.contactDevBtn;
    document.getElementById('addFriendTitle').textContent = t.addFriendTitle;
    document.getElementById('sendRequestBtn').textContent = t.sendRequestBtn;
    document.getElementById('genderQuestion').textContent = t.genderQuestion;
    const genderBtns = document.querySelectorAll('#genderScreen .btn-primary');
    if (genderBtns[0]) genderBtns[0].textContent = t.male;
    if (genderBtns[1]) genderBtns[1].textContent = t.female;
  }

  function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(el => {
      el.classList.remove('active');
      el.style.display = 'none';
    });
    const screen = document.getElementById(screenId);
    screen.style.display = 'block';
    screen.classList.add('active');
    if (screenId === 'mainScreen') loadFriends();
  }

  async function createAccount() {
    const name = document.getElementById('crName').value.trim();
    const age = parseInt(document.getElementById('crAge').value);
    const pass = document.getElementById('crPass').value;
    const pass2 = document.getElementById('crPass2').value;
    if (!name || !age || !pass || pass !== pass2 || age < 12) {
      alert("Please fill all fields correctly. Age must be at least 12.");
      return;
    }
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, name + "@vchat.fake", pass);
      const user = userCredential.user;
      await setDoc(doc(db, "users", user.uid), {
        name: name,
        age: age,
        gender: null,
        createdAt: serverTimestamp()
      });
      showScreen('genderScreen');
    } catch (error) {
      alert("Error: " + error.message);
    }
  }

  async function login() {
    const name = document.getElementById('rrName').value.trim();
    const pass = document.getElementById('rrPass').value;
    if (!name || !pass) {
      alert("Please fill all fields.");
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, name + "@vchat.fake", pass);
    } catch (error) {
      alert("Login failed: " + error.message);
    }
  }

  function forgotPassword() {
    const lang = getLang();
    const message = lang === 'ar' 
      ? "يجب عليك التواصل مع مطور V Chat. للتواصل معه اضغط على الزر." 
      : "You must contact the V Chat developer. Click the button to contact.";
    if (confirm(message)) {
      window.open("https://www.instagram.com/maybe_7oka?utm_source=ig_web_button_share_sheet&igsh=ajVhZWd4NDl6c2Rv", "_blank");
    }
  }

  function contactDev() {
    window.open("https://www.instagram.com/maybe_7oka?utm_source=ig_web_button_share_sheet&igsh=ajVhZWd4NDl6c2Rv", "_blank");
  }

  async function setGender(gender) {
    const user = auth.currentUser;
    const avatarUrl = gender === 'male'
      ? 'https://images.unsplash.com/photo-1529665253569-6d01c0eaf7b6?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NHx8cHJvZmlsZXxlbnwwfHwwfHx8MA%3D%3D&fm=jpg&q=60&w=3000'
      : 'https://images.unsplash.com/photo-1607167334063-459f8a1eb997?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8N3x8cHJvZmlsZSUyMGdpcmx8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&q=60&w=500';
    await setDoc(doc(db, "users", user.uid), { gender, avatarUrl }, { merge: true });
    loadMainScreen();
  }

  async function loadMainScreen() {
    const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
    const userData = userDoc.data();
    document.getElementById('currentUserName').textContent = userData.name;
    document.getElementById('currentUserAvatar').src = userData.avatarUrl;
    showScreen('mainScreen');
  }

  function showAddFriend() {
    document.getElementById('addFriendModal').style.display = 'block';
  }

  async function sendFriendRequest() {
    const friendName = document.getElementById('friendNameInput').value.trim();
    if (!friendName) return;
    const q = query(collection(db, "users"), where("name", "==", friendName));
    const querySnapshot = await getDocs(q);
    const statusEl = document.getElementById('addFriendStatus');
    if (querySnapshot.empty) {
      statusEl.innerHTML = `<span class="error">${getLang() === 'ar' ? 'فشل! يرجى كتابة الاسم صحيح' : 'Failed! Please enter correct name'}</span>`;
      return;
    }
    const friend = querySnapshot.docs[0];
    const chatId = [auth.currentUser.uid, friend.id].sort().join('_');
    await setDoc(doc(db, "chats", chatId), {
      user1: auth.currentUser.uid,
      user2: friend.id,
      status: "requested",
      requestedBy: auth.currentUser.uid
    }, { merge: true });
    statusEl.innerHTML = `<span class="success">${getLang() === 'ar' ? 'تم الإرسال' : 'Sent!'}</span>`;
    setTimeout(() => {
      document.getElementById('addFriendModal').style.display = 'none';
      document.getElementById('friendNameInput').value = '';
    }, 1500);
  }

  function toggleRequests() {
    const box = document.getElementById('requestsBox');
    box.style.display = box.style.display === 'block' ? 'none' : 'block';
  }

  async function loadFriends() {
    const q1 = query(collection(db, "chats"), where("user1", "==", auth.currentUser.uid));
    const q2 = query(collection(db, "chats"), where("user2", "==", auth.currentUser.uid));
    const [snapshot1, snapshot2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const allChats = [...snapshot1.docs, ...snapshot2.docs];
    const friendsList = document.getElementById('friendsList');
    const requestsBox = document.getElementById('requestsBox');
    friendsList.innerHTML = '';
    requestsBox.innerHTML = '';
    for (const docSnap of allChats) {
      const data = docSnap.data();
      const otherUid = data.user1 === auth.currentUser.uid ? data.user2 : data.user1;
      const userSnap = await getDoc(doc(db, "users", otherUid));
      if (!userSnap.exists()) continue;
      const userData = userSnap.data();
      if (data.status === "accepted") {
        const div = document.createElement('div');
        div.className = 'friend-item';
        div.innerHTML = `<img class="avatar" src="${userData.avatarUrl}" /><span>${userData.name}</span>`;
        div.onclick = () => openChat(otherUid, userData.name, userData.avatarUrl, docSnap.id);
        friendsList.appendChild(div);
      } else if (data.status === "requested" && data.requestedBy !== auth.currentUser.uid) {
        const div = document.createElement('div');
        div.className = 'request-item';
        div.innerHTML = `<div>${userData.name} wants to be your friend</div><button class="btn btn-success" onclick="acceptRequest('${docSnap.id}')">✓</button><button class="btn btn-danger" onclick="rejectRequest('${docSnap.id}')">✗</button>`;
        requestsBox.appendChild(div);
      }
    }
  }

  async function acceptRequest(chatId) {
    await setDoc(doc(db, "chats", chatId), { status: "accepted" }, { merge: true });
    toggleRequests();
    loadFriends();
  }

  async function rejectRequest(chatId) {
    await deleteDoc(doc(db, "chats", chatId));
    toggleRequests();
    loadFriends();
  }

  function openChat(uid, name, avatar, chatId) {
    currentChatUser = { uid, name, avatar };
    currentChatId = chatId;
    document.getElementById('messagesBox').innerHTML = '';
    loadMessages(chatId);
  }

  function loadMessages(chatId) {
    const messagesBox = document.getElementById('messagesBox');
    const q = query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("timestamp"));
    onSnapshot(q, (snapshot) => {
      messagesBox.innerHTML = '';
      snapshot.forEach((doc) => {
        const msg = doc.data();
        const isSent = msg.senderId === auth.currentUser.uid;
        const time = msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const div = document.createElement('div');
        div.className = `message ${isSent ? 'sent' : 'received'}`;
        div.innerHTML = `${msg.text}<br/><small>${time}</small>`;
        messagesBox.appendChild(div);
      });
      messagesBox.scrollTop = messagesBox.scrollHeight;
    });
  }

  function handleKeyPress(e) {
    if (e.key === 'Enter') sendMessage();
  }

  async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text || !currentChatId) return;
    await addDoc(collection(db, "messages"), {
      chatId: currentChatId,
      senderId: auth.currentUser.uid,
      text: text,
      timestamp: serverTimestamp()
    });
    input.value = '';
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists() && userDoc.data().gender !== null) {
        loadMainScreen();
      } else {
        showScreen('genderScreen');
      }
    } else {
      showScreen('inScreen');
    }
  });

  window.onload = () => {
    const savedLang = getLang();
    document.getElementById('htmlTag').dir = savedLang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('htmlTag').lang = savedLang;
    updateTexts(savedLang);
  };
</script>

</body>
</html>