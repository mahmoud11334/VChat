<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V Chat</title>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #000000;
      color: #ffffff;
      min-height: 100vh;
    }

    .hidden {
      display: none !important;
    }

    .screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
      border: 2px solid #ff6b00;
      border-radius: 24px;
      padding: 40px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(255, 107, 0, 0.3);
    }

    .logo {
      text-align: center;
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 30px;
      color: #ffffff;
      text-shadow: 0 0 20px rgba(255, 107, 0, 0.5);
    }

    .subtitle {
      text-align: center;
      font-size: 20px;
      margin-bottom: 30px;
      color: #ffffff;
    }

    .btn {
      width: 100%;
      padding: 16px 24px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }

    .btn-orange {
      background-color: #ff6b00;
      color: #ffffff;
    }

    .btn-orange:hover {
      background-color: #e65c00;
    }

    .btn-green {
      background-color: #0d6832;
      color: #ffffff;
    }

    .btn-green:hover {
      background-color: #0a5228;
    }

    .input-field {
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      background-color: #1a1a1a;
      color: #ffffff;
      border: 2px solid #333333;
      border-radius: 12px;
      margin-bottom: 15px;
      outline: none;
    }

    .input-field:focus {
      border-color: #ff6b00;
    }

    .text-link {
      width: 100%;
      background: none;
      border: none;
      color: #ff6b00;
      text-decoration: underline;
      cursor: pointer;
      padding: 10px;
      font-size: 16px;
    }

    .info-text {
      text-align: center;
      font-size: 14px;
      color: #999999;
      margin: 15px 0;
    }

    .warning-text {
      text-align: center;
      font-size: 14px;
      color: #ff6b00;
      margin: 10px 0;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: #1a1a1a;
      border: 2px solid #ff6b00;
      border-radius: 16px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
    }

    .btn-instagram {
      background: linear-gradient(45deg, #833ab4, #fd1d1d, #fcb045);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      margin-bottom: 15px;
    }

    .btn-close {
      width: 100%;
      padding: 10px;
      background-color: #333333;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
    }

    .main-screen {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      background: #1a1a1a;
      border-bottom: 2px solid #ff6b00;
      padding: 15px 20px;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .profile-pic {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ff6b00;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .sidebar {
      width: 320px;
      background-color: #1a1a1a;
      border-left: 2px solid #2a2a2a;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 15px;
      border-bottom: 2px solid #2a2a2a;
    }

    .sidebar-buttons {
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn-orange {
      background-color: #ff6b00;
      color: white;
    }

    .icon-btn-green {
      background-color: #0d6832;
      color: white;
    }

    .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #dc0000;
      color: white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .sidebar-panel {
      padding: 15px;
      border-bottom: 2px solid #2a2a2a;
    }

    .panel-title {
      font-weight: bold;
      margin-bottom: 15px;
    }

    .request-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #2a2a2a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .request-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .request-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ff6b00;
    }

    .btn-accept {
      background-color: #0d6832;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-reject {
      background-color: #dc0000;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .status-message {
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
    }

    .status-success {
      background-color: rgba(13, 104, 50, 0.3);
      color: #0d6832;
    }

    .status-error {
      background-color: rgba(220, 0, 0, 0.3);
      color: #dc0000;
    }

    .friends-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .friend-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      background-color: #2a2a2a;
    }

    .friend-item:hover {
      background-color: #333333;
    }

    .friend-item.active {
      background-color: #ff6b00;
    }

    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #000000;
    }

    .chat-header {
      background-color: #1a1a1a;
      border-bottom: 2px solid #2a2a2a;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .message {
      margin-bottom: 12px;
      max-width: 70%;
    }

    .message-sent {
      margin-left: auto;
    }

    .message-received {
      margin-right: auto;
    }

    .message-content {
      padding: 12px 16px;
      border-radius: 16px;
    }

    .message-sent .message-content {
      background-color: #ff6b00;
      color: white;
    }

    .message-received .message-content {
      background-color: #2a2a2a;
      color: white;
    }

    .message-time {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
    }

    .chat-input-area {
      background-color: #1a1a1a;
      border-top: 2px solid #2a2a2a;
      padding: 15px 20px;
    }

    .chat-input-form {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 18px;
      background-color: #2a2a2a;
      color: white;
      border: 2px solid #333333;
      border-radius: 24px;
      outline: none;
    }

    .btn-send {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #ff6b00;
      color: white;
      border: none;
      cursor: pointer;
    }

    .empty-chat {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .no-items {
      text-align: center;
      color: #999999;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="screen-in" class="screen">
  <div class="container">
    <div class="logo">V Chat</div>
    <div class="subtitle">Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©</div>
    <button class="btn btn-orange" onclick="selectLanguage('ar')">Ø¹Ø±Ø¨ÙŠ</button>
    <button class="btn btn-green" onclick="selectLanguage('en')">English</button>
  </div>
</div>

<div id="screen-sgn" class="screen hidden">
  <div class="container">
    <div class="logo">V Chat</div>
    <button class="btn btn-orange" onclick="showScreen('crsgn')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    <button class="btn btn-green" onclick="showScreen('rrsgn')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<div id="screen-crsgn" class="screen hidden">
  <div class="container">
    <h2 class="subtitle">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
    <input type="text" id="create-name" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù…">
    <input type="number" id="create-age" class="input-field" placeholder="Ø§Ù„Ø¹Ù…Ø±">
    <input type="password" id="create-password" class="input-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <input type="password" id="create-confirm-password" class="input-field" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <p class="info-text">ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ­ÙØ¸ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±Ùƒ Ø¬ÙŠØ¯Ø§Ù‹</p>
    <p class="warning-text">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¹Ù…Ø± Ù‡Ùˆ 12 Ø¹Ø§Ù…</p>
    <button class="btn btn-green" onclick="createAccount()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    <button class="text-link" onclick="showScreen('rrsgn')">Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„</button>
  </div>
</div>

<div id="screen-rrsgn" class="screen hidden">
  <div class="container">
    <h2 class="subtitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="text" id="signin-name" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù…">
    <input type="password" id="signin-password" class="input-field" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="btn btn-green" onclick="signIn()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button class="text-link" onclick="showForgotPasswordModal()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
    <button class="text-link" onclick="showScreen('crsgn')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
  </div>
</div>

<div id="forgot-password-modal" class="modal hidden">
  <div class="modal-content">
    <p style="text-align: center; margin-bottom: 20px;">ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø·ÙˆØ± V Chat</p>
    <p style="text-align: center; margin-bottom: 20px; font-size: 14px; color: #999;">Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±</p>
    <a href="https://www.instagram.com/maybe_7oka" target="_blank" class="btn-instagram">
      <span>Instagram</span>
    </a>
    <button class="btn-close" onclick="closeForgotPasswordModal()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<div id="screen-gender" class="screen hidden">
  <div class="container">
    <h2 class="subtitle">Ù…Ø§ Ù‡Ùˆ Ù†ÙˆØ¹ÙƒØŸ</h2>
    <button class="btn btn-orange" onclick="selectGender('male')">Ø°ÙƒØ±</button>
    <button class="btn btn-green" onclick="selectGender('female')">Ø£Ù†Ø«Ù‰</button>
  </div>
</div>

<div id="screen-main" class="main-screen hidden">
  <div class="header">
    <div class="header-content">
      <div class="user-info">
        <img id="header-profile-pic" src="" alt="Profile" class="profile-pic">
        <div>
          <div style="font-weight: bold;" id="header-username"></div>
          <div style="font-size: 14px; color: #0d6832;" id="header-status">Ù…ØªØµÙ„</div>
        </div>
      </div>
      <a href="https://www.instagram.com/maybe_7oka" target="_blank" class="btn-instagram" style="width: auto; margin: 0;">
        ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±
      </a>
    </div>
  </div>

  <div class="main-content">
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-buttons">
          <button class="icon-btn icon-btn-orange" onclick="toggleAddFriend()">+</button>
          <button class="icon-btn icon-btn-green" onclick="toggleRequests()">
            ğŸ””
            <span id="requests-badge" class="badge hidden">0</span>
          </button>
        </div>
      </div>

      <div id="add-friend-panel" class="sidebar-panel hidden">
        <div class="panel-title">Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚</div>
        <input type="text" id="friend-username-input" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <button class="btn btn-green" onclick="sendFriendRequest()">Ø¥Ø±Ø³Ø§Ù„</button>
        <div id="request-status" class="status-message hidden"></div>
      </div>

      <div id="requests-panel" class="sidebar-panel hidden">
        <div class="panel-title">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</div>
        <div id="requests-list"></div>
      </div>

      <div class="friends-list">
        <div class="panel-title">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</div>
        <div id="friends-list"></div>
      </div>
    </div>

    <div class="chat-area" id="chat-area">
      <div id="empty-chat" class="empty-chat">
        <h2 style="font-size: 36px; margin-bottom: 15px;">V Chat</h2>
        <p style="color: #999999;">Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
      </div>

      <div id="active-chat" class="hidden" style="display: flex; flex-direction: column; flex: 1;">
        <div class="chat-header">
          <img id="chat-friend-pic" src="" alt="Friend" class="profile-pic">
          <div>
            <div style="font-weight: bold;" id="chat-friend-name"></div>
            <div style="font-size: 14px;" id="chat-friend-status"></div>
          </div>
        </div>

        <div class="chat-messages" id="chat-messages"></div>

        <div class="chat-input-area">
          <div class="chat-input-form">
            <input type="text" id="message-input" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
            <button class="btn-send" onclick="sendMessage()">â¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBeqpM29LfwF05lv8ze7y5b-an-GI2D_S4",
  authDomain: "vchat-230ea.firebaseapp.com",
  databaseURL: "https://vchat-230ea-default-rtdb.firebaseio.com",
  projectId: "vchat-230ea",
  storageBucket: "vchat-230ea.firebasestorage.app",
  messagingSenderId: "912119309781",
  appId: "1:912119309781:web:2a91a8f1f44381a925495c",
  measurementId: "G-W42NJQMEZW"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

let currentLanguage = 'ar';
let currentUser = null;
let allUsers = {};
let friendRequests = {};
let friends = {};
let messages = {};
let activeChat = null;

const translations = {
  ar: {
    online: 'Ù…ØªØµÙ„',
    offline: 'ØºÙŠØ± Ù…ØªØµÙ„',
    selectFriend: 'Ø§Ø®ØªØ± ØµØ¯ÙŠÙ‚ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©',
    noFriends: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡',
    noRequests: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª',
    sent: 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',
    failed: 'ÙØ´Ù„! ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ØµØ­ÙŠØ­',
    fillFields: 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„',
    minAge: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¹Ù…Ø± Ù‡Ùˆ 12 Ø¹Ø§Ù…',
    passwordMismatch: 'ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©',
    userExists: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„',
    wrongCredentials: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'
  },
  en: {
    online: 'Online',
    offline: 'Offline',
    selectFriend: 'Select a friend to start chatting',
    noFriends: 'No friends yet',
    noRequests: 'No requests',
    sent: 'Sent',
    failed: 'Failed! Please write the name correctly',
    fillFields: 'Please fill all fields',
    minAge: 'Minimum age is 12 years',
    passwordMismatch: 'Passwords do not match',
    userExists: 'User already exists',
    wrongCredentials: 'Wrong username or password'
  }
};

function t(key) {
  return translations[currentLanguage][key];
}

async function updateOnlineStatus(isOnline) {
  if (!currentUser) return;
  const onlineRef = database.ref('online/' + currentUser.uid);
  if (isOnline) {
    await onlineRef.set(firebase.database.ServerValue.TIMESTAMP);
    onlineRef.onDisconnect().remove();
  } else {
    await onlineRef.remove();
  }
}

function isUserOnline(uid) {
  const lastSeen = allUsers[uid]?.lastSeen;
  if (lastSeen == null) return false;
  return (Date.now() - lastSeen) < 10000;
}

async function createAccount() {
  const name = document.getElementById('create-name').value.trim();
  const age = document.getElementById('create-age').value;
  const password = document.getElementById('create-password').value;
  const confirmPassword = document.getElementById('create-confirm-password').value;

  if (!name || !age || !password || !confirmPassword) {
    alert(t('fillFields'));
    return;
  }

  if (parseInt(age) < 12) {
    alert(t('minAge'));
    return;
  }

  if (password !== confirmPassword) {
    alert(t('passwordMismatch'));
    return;
  }

  try {
    const email = name + '@vchat.fake';
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const uid = userCredential.user.uid;

    const userData = {
      username: name,
      age: parseInt(age),
      gender: null,
      profilePic: ''
    };

    await database.ref('users/' + uid).set(userData);
    currentUser = { uid, ...userData };
    showScreen('gender');
  } catch (error) {
    console.error('Create account error:', error);
    if (error.code === 'auth/email-already-in-use') {
      alert(t('userExists'));
    } else {
      alert('Ø®Ø·Ø£: ' + (error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'));
    }
  }
}

async function signIn() {
  const name = document.getElementById('signin-name').value.trim();
  const password = document.getElementById('signin-password').value;

  if (!name || !password) {
    alert(t('fillFields'));
    return;
  }

  try {
    const email = name + '@vchat.fake';
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const uid = userCredential.user.uid;

    const userSnapshot = await database.ref('users/' + uid).once('value');
    if (userSnapshot.exists()) {
      currentUser = { uid, ...userSnapshot.val() };
      await updateOnlineStatus(true);
      showScreen('main');
      loadAllData();
      startRealtimeListener();
    } else {
      alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
    }
  } catch (error) {
    console.error('Sign in error:', error);
    alert(t('wrongCredentials'));
  }
}

async function selectGender(gender) {
  const profilePic = gender === 'male'
    ? 'https://images.unsplash.com/photo-1529665253569-6d01c0eaf7b6?w=300'
    : 'https://images.unsplash.com/photo-1607167334063-459f8a1eb997?w=300';

  currentUser.gender = gender;
  currentUser.profilePic = profilePic;

  await database.ref('users/' + currentUser.uid).update({
    gender: gender,
    profilePic: profilePic
  });

  await updateOnlineStatus(true);
  showScreen('main');
  loadAllData();
  startRealtimeListener();
}

async function loadAllData() {
  try {
    const [usersSnap, requestsSnap, friendsSnap, messagesSnap, onlineSnap] = await Promise.all([
      database.ref('users').once('value'),
      database.ref('requests').once('value'),
      database.ref('friends').once('value'),
      database.ref('messages').once('value'),
      database.ref('online').once('value')
    ]);

    allUsers = usersSnap.val() || {};
    friendRequests = requestsSnap.val() || {};
    friends = friendsSnap.val() || {};
    messages = messagesSnap.val() || {};

    const onlineData = onlineSnap.val() || {};
    Object.keys(allUsers).forEach(uid => {
      allUsers[uid].lastSeen = onlineData[uid] || 0;
    });

    updateUI();
  } catch (err) {
    console.error('Load data error:', err);
  }
}

function startRealtimeListener() {
  database.ref().on('value', (snapshot) => {
    const data = snapshot.val() || {};
    allUsers = data.users || {};
    friendRequests = data.requests || {};
    friends = data.friends || {};
    messages = data.messages || {};

    const onlineData = data.online || {};
    Object.keys(allUsers).forEach(uid => {
      allUsers[uid].lastSeen = onlineData[uid] || 0;
    });

    if (currentUser) updateUI();
  });
}

function selectLanguage(lang) {
  currentLanguage = lang;
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
  showScreen('sgn');
}

function showScreen(screenId) {
  document.querySelectorAll('.screen, .main-screen').forEach(s => s.classList.add('hidden'));
  document.getElementById('screen-' + screenId).classList.remove('hidden');
}

function showForgotPasswordModal() {
  document.getElementById('forgot-password-modal').classList.remove('hidden');
}

function closeForgotPasswordModal() {
  document.getElementById('forgot-password-modal').classList.add('hidden');
}

function toggleAddFriend() {
  const panel = document.getElementById('add-friend-panel');
  const requestsPanel = document.getElementById('requests-panel');
  requestsPanel.classList.add('hidden');
  panel.classList.toggle('hidden');
}

function toggleRequests() {
  const panel = document.getElementById('requests-panel');
  const addPanel = document.getElementById('add-friend-panel');
  addPanel.classList.add('hidden');
  panel.classList.toggle('hidden');
  renderRequests();
}

async function sendFriendRequest() {
  const username = document.getElementById('friend-username-input').value.trim();
  const statusEl = document.getElementById('request-status');

  if (!username) return;

  const targetUid = Object.keys(allUsers).find(uid => allUsers[uid].username === username);
  if (!targetUid || targetUid === currentUser.uid) {
    statusEl.textContent = t('failed');
    statusEl.className = 'status-message status-error';
    statusEl.classList.remove('hidden');
    setTimeout(() => statusEl.classList.add('hidden'), 3000);
    return;
  }

  if (!friendRequests[targetUid]) friendRequests[targetUid] = [];
  if (!friendRequests[targetUid].includes(currentUser.uid)) {
    friendRequests[targetUid].push(currentUser.uid);
    await database.ref('requests/' + targetUid).set(friendRequests[targetUid]);
  }

  statusEl.textContent = t('sent');
  statusEl.className = 'status-message status-success';
  statusEl.classList.remove('hidden');
  setTimeout(() => {
    statusEl.classList.add('hidden');
    document.getElementById('friend-username-input').value = '';
  }, 2000);
}

async function acceptRequest(requesterUid) {
  const myFriends = friends[currentUser.uid] || [];
  const theirFriends = friends[requesterUid] || [];

  if (!myFriends.includes(requesterUid)) myFriends.push(requesterUid);
  if (!theirFriends.includes(currentUser.uid)) theirFriends.push(currentUser.uid);

  await database.ref('friends/' + currentUser.uid).set(myFriends);
  await database.ref('friends/' + requesterUid).set(theirFriends);

  friendRequests[currentUser.uid] = (friendRequests[currentUser.uid] || []).filter(uid => uid !== requesterUid);
  await database.ref('requests/' + currentUser.uid).set(friendRequests[currentUser.uid].length ? friendRequests[currentUser.uid] : null);

  updateUI();
}

async function rejectRequest(requesterUid) {
  friendRequests[currentUser.uid] = (friendRequests[currentUser.uid] || []).filter(uid => uid !== requesterUid);
  await database.ref('requests/' + currentUser.uid).set(friendRequests[currentUser.uid].length ? friendRequests[currentUser.uid] : null);
  updateUI();
}

function renderRequests() {
  const container = document.getElementById('requests-list');
  const userRequests = friendRequests[currentUser.uid] || [];
  const badge = document.getElementById('requests-badge');

  if (userRequests.length === 0) {
    container.innerHTML = '<div class="no-items">' + t('noRequests') + '</div>';
    badge.classList.add('hidden');
  } else {
    badge.textContent = userRequests.length;
    badge.classList.remove('hidden');
    container.innerHTML = userRequests.map(requesterUid => {
      const user = allUsers[requesterUid];
      if (!user) return '';
      return `
        <div class="request-item">
          <div class="request-user">
            <img src="${user.profilePic || 'https://via.placeholder.com/40'}" class="request-pic" alt="${user.username}">
            <span>${user.username}</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn-accept" onclick="acceptRequest('${requesterUid}')">âœ“</button>
            <button class="btn-reject" onclick="rejectRequest('${requesterUid}')">âœ—</button>
          </div>
        </div>
      `;
    }).join('');
  }
}

function renderFriends() {
  const container = document.getElementById('friends-list');
  const userFriends = friends[currentUser.uid] || [];

  if (userFriends.length === 0) {
    container.innerHTML = '<div class="no-items">' + t('noFriends') + '</div>';
  } else {
    container.innerHTML = userFriends.map(friendUid => {
      const friend = allUsers[friendUid];
      if (!friend) return '';
      const online = isUserOnline(friendUid);
      const isActive = activeChat === friendUid ? 'active' : '';
      return `
        <div class="friend-item ${isActive}" onclick="openChat('${friendUid}')">
          <img src="${friend.profilePic || 'https://via.placeholder.com/50'}" class="profile-pic" alt="${friend.username}">
          <div style="flex: 1;">
            <div style="font-weight: bold;">${friend.username}</div>
            <div style="font-size: 14px; color: ${online ? '#0d6832' : '#999999'};">
              ${online ? t('online') : t('offline')}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }
}

function openChat(friendUid) {
  activeChat = friendUid;
  document.getElementById('empty-chat').classList.add('hidden');
  const activeChatEl = document.getElementById('active-chat');
  activeChatEl.classList.remove('hidden');
  activeChatEl.style.display = 'flex';

  const friend = allUsers[friendUid];
  document.getElementById('chat-friend-pic').src = friend.profilePic || 'https://via.placeholder.com/50';
  document.getElementById('chat-friend-name').textContent = friend.username;

  const online = isUserOnline(friendUid);
  const statusEl = document.getElementById('chat-friend-status');
  statusEl.textContent = online ? t('online') : t('offline');
  statusEl.style.color = online ? '#0d6832' : '#999999';

  renderMessages();
  renderFriends();
}

function renderMessages() {
  if (!activeChat) return;

  const chatId = [currentUser.uid, activeChat].sort().join('_');
  const chatMessages = messages[chatId] || [];

  const container = document.getElementById('chat-messages');
  container.innerHTML = chatMessages.map(msg => {
    const isSent = msg.senderUid === currentUser.uid;
    return `
      <div class="message ${isSent ? 'message-sent' : 'message-received'}">
        <div class="message-content">
          <div>${msg.text}</div>
          <div class="message-time">${msg.timestamp}</div>
        </div>
      </div>
    `;
  }).join('');

  container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('message-input');
  const text = input.value.trim();

  if (!text || !activeChat) return;

  const chatId = [currentUser.uid, activeChat].sort().join('_');
  const now = new Date();
  const timestamp = now.toLocaleTimeString(currentLanguage === 'ar' ? 'ar-EG' : 'en-US', {
    hour: '2-digit',
    minute: '2-digit'
  });

  const newMessage = {
    senderUid: currentUser.uid,
    text: text,
    timestamp: timestamp
  };

  const chatRef = database.ref('messages/' + chatId);
  await chatRef.push(newMessage);

  input.value = '';
}

document.addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && activeChat) {
    const input = document.getElementById('message-input');
    if (document.activeElement === input) {
      sendMessage();
    }
  }
});

function updateUI() {
  if (!currentUser) return;

  document.getElementById('header-profile-pic').src = currentUser.profilePic || 'https://via.placeholder.com/50';
  document.getElementById('header-username').textContent = currentUser.username;

  renderRequests();
  renderFriends();

  if (activeChat) {
    renderMessages();
  }
}

auth.onAuthStateChanged(async (user) => {
  if (user) {
    const uid = user.uid;
    const userSnapshot = await database.ref('users/' + uid).once('value');
    if (userSnapshot.exists()) {
      currentUser = { uid, ...userSnapshot.val() };
      await updateOnlineStatus(true);
      showScreen('main');
      loadAllData();
      startRealtimeListener();
    }
  } else {
    showScreen('in');
  }
});
</script>
</body>
</html>