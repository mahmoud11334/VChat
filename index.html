<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V Chat</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#000;color:#fff;min-height:100vh}.hidden{display:none!important}.screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}.container{background:linear-gradient(135deg,#1a1a1a 0%,#000 100%);border:2px solid #ff6b00;border-radius:24px;padding:40px;max-width:450px;width:100%;box-shadow:0 20px 60px rgba(255,107,0,.3)}.logo{text-align:center;font-size:48px;font-weight:bold;margin-bottom:30px;color:#fff;text-shadow:0 0 20px rgba(255,107,0,.5)}.subtitle{text-align:center;font-size:20px;margin-bottom:30px;color:#fff}.btn{width:100%;padding:16px 24px;font-size:20px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;transition:all .3s;margin-bottom:15px}.btn-orange{background:#ff6b00;color:#fff}.btn-orange:hover{background:#e65c00}.btn-green{background:#0d6832;color:#fff}.btn-green:hover{background:#0a5228}.input-field{width:100%;padding:14px 18px;font-size:16px;background:#1a1a1a;color:#fff;border:2px solid #333;border-radius:12px;margin-bottom:15px;outline:none}.input-field:focus{border-color:#ff6b00}.text-link{width:100%;background:none;border:none;color:#ff6b00;text-decoration:underline;cursor:pointer;padding:10px;font-size:16px}.info-text{text-align:center;font-size:14px;color:#999;margin:15px 0}.warning-text{text-align:center;font-size:14px;color:#ff6b00;margin:10px 0}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}.modal-content{background:#1a1a1a;border:2px solid #ff6b00;border-radius:16px;padding:30px;max-width:400px;width:100%}.btn-instagram{background:linear-gradient(45deg,#833ab4,#fd1d1d,#fcb045);display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 24px;border:none;border-radius:12px;color:#fff;font-weight:bold;cursor:pointer;text-decoration:none;margin-bottom:15px}.btn-close{width:100%;padding:10px;background:#333;color:#fff;border:none;border-radius:12px;cursor:pointer}.main-screen{display:flex;flex-direction:column;height:100vh}.header{background:#1a1a1a;border-bottom:2px solid #ff6b00;padding:15px 20px}.header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}.user-info{display:flex;align-items:center;gap:12px}.profile-pic{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #ff6b00}.main-content{display:flex;flex:1;overflow:hidden;max-width:1200px;margin:0 auto;width:100%}.sidebar{width:320px;background:#1a1a1a;border-left:2px solid #2a2a2a;display:flex;flex-direction:column}.sidebar-header{padding:15px;border-bottom:2px solid #2a2a2a}.sidebar-buttons{display:flex;gap:10px}.icon-btn{flex:1;padding:12px;border:none;border-radius:8px;cursor:pointer;position:relative;display:flex;align-items:center;justify-content:center}.icon-btn-orange{background:#ff6b00;color:#fff}.icon-btn-green{background:#0d6832;color:#fff}.badge{position:absolute;top:-5px;right:-5px;background:#dc0000;color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:12px}.sidebar-panel{padding:15px;border-bottom:2px solid #2a2a2a}.panel-title{font-weight:bold;margin-bottom:15px}.request-item{display:flex;align-items:center;justify-content:space-between;background:#2a2a2a;padding:12px;border-radius:8px;margin-bottom:10px}.request-user{display:flex;align-items:center;gap:10px}.request-pic{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #ff6b00}.btn-accept{background:#0d6832;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}.btn-reject{background:#dc0000;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}.status-message{text-align:center;padding:8px;border-radius:6px;margin-top:10px;font-size:14px}.status-success{background:rgba(13,104,50,.3);color:#0d6832}.status-error{background:rgba(220,0,0,.3);color:#dc0000}.friends-list{flex:1;overflow-y:auto;padding:15px}.friend-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;margin-bottom:10px;cursor:pointer;background:#2a2a2a}.friend-item:hover{background:#333}.friend-item.active{background:#ff6b00}.chat-area{flex:1;display:flex;flex-direction:column;background:#000}.chat-header{background:#1a1a1a;border-bottom:2px solid #2a2a2a;padding:15px 20px;display:flex;align-items:center;gap:12px}.chat-messages{flex:1;overflow-y:auto;padding:20px}.message{margin-bottom:12px;max-width:70%}.message-sent{margin-left:auto}.message-received{margin-right:auto}.message-content{padding:12px 16px;border-radius:16px}.message-sent .message-content{background:#ff6b00;color:#fff}.message-received .message-content{background:#2a2a2a;color:#fff}.message-time{font-size:12px;opacity:.7;margin-top:4px}.chat-input-area{background:#1a1a1a;border-top:2px solid #2a2a2a;padding:15px 20px}.chat-input-form{display:flex;gap:10px}.chat-input{flex:1;padding:12px 18px;background:#2a2a2a;color:#fff;border:2px solid #333;border-radius:24px;outline:none}.btn-send{width:50px;height:50px;border-radius:50%;background:#ff6b00;color:#fff;border:none;cursor:pointer}.empty-chat{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column}.no-items{text-align:center;color:#999;font-size:14px}
  </style>
</head>
<body>

<div id="screen-in" class="screen">
  <div class="container">
    <div class="logo">V Chat</div>
    <div class="subtitle">اختر اللغة</div>
    <button class="btn btn-orange" onclick="selectLanguage('ar')">عربي</button>
    <button class="btn btn-green" onclick="selectLanguage('en')">English</button>
  </div>
</div>

<div id="screen-sgn" class="screen hidden">
  <div class="container">
    <div class="logo">V Chat</div>
    <button class="btn btn-orange" onclick="showScreen('crsgn')">إنشاء حساب</button>
    <button class="btn btn-green" onclick="showScreen('rrsgn')">تسجيل الدخول</button>
  </div>
</div>

<div id="screen-crsgn" class="screen hidden">
  <div class="container">
    <h2 class="subtitle">إنشاء حساب</h2>
    <input type="text" id="create-name" class="input-field" placeholder="الاسم">
    <input type="number" id="create-age" class="input-field" placeholder="العمر">
    <input type="password" id="create-password" class="input-field" placeholder="كلمة المرور">
    <input type="password" id="create-confirm-password" class="input-field" placeholder="تأكيد كلمة المرور">
    <p class="info-text">تأكد من أنك تحفظ كلمة مرورك جيداً</p>
    <p class="warning-text">الحد الأدنى للعمر هو 12 عام</p>
    <button class="btn btn-green" onclick="createAccount()">إنشاء حساب</button>
    <button class="text-link" onclick="showScreen('rrsgn')">لدي حساب بالفعل</button>
  </div>
</div>

<div id="screen-rrsgn" class="screen hidden">
  <div class="container">
    <h2 class="subtitle">تسجيل الدخول</h2>
    <input type="text" id="signin-name" class="input-field" placeholder="الاسم">
    <input type="password" id="signin-password" class="input-field" placeholder="كلمة المرور">
    <button class="btn btn-green" onclick="signIn()">تسجيل الدخول</button>
    <button class="text-link" onclick="showForgotPasswordModal()">نسيت كلمة السر</button>
    <button class="text-link" onclick="showScreen('crsgn')">إنشاء حساب جديد</button>
  </div>
</div>

<div id="forgot-password-modal" class="modal hidden">
  <div class="modal-content">
    <p style="text-align:center;margin-bottom:20px;">يجب عليك التواصل مع مطور V Chat</p>
    <p style="text-align:center;margin-bottom:20px;font-size:14px;color:#999;">للتواصل معه اضغط على الزر</p>
    <a href="https://www.instagram.com/maybe_7oka" target="_blank" class="btn-instagram"><span>Instagram</span></a>
    <button class="btn-close" onclick="closeForgotPasswordModal()">إغلاق</button>
  </div>
</div>

<div id="screen-gender" class="screen hidden">
  <div class="container">
    <h2 class="subtitle">ما هو نوعك؟</h2>
    <button class="btn btn-orange" onclick="selectGender('male')">ذكر</button>
    <button class="btn btn-green" onclick="selectGender('female')">أنثى</button>
  </div>
</div>

<div id="screen-main" class="main-screen hidden">
  <div class="header">
    <div class="header-content">
      <div class="user-info">
        <img id="header-profile-pic" src="" alt="Profile" class="profile-pic">
        <div>
          <div style="font-weight:bold;" id="header-username"></div>
          <div style="font-size:14px;color:#0d6832;" id="header-status">متصل</div>
        </div>
      </div>
      <a href="https://www.instagram.com/maybe_7oka" target="_blank" class="btn-instagram" style="width:auto;margin:0;">تحدث مع المطور</a>
    </div>
  </div>
  <div class="main-content">
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-buttons">
          <button class="icon-btn icon-btn-orange" onclick="toggleAddFriend()">+</button>
          <button class="icon-btn icon-btn-green" onclick="toggleRequests()">🔔<span id="requests-badge" class="badge hidden">0</span></button>
        </div>
      </div>
      <div id="add-friend-panel" class="sidebar-panel hidden">
        <div class="panel-title">إضافة صديق</div>
        <input type="text" id="friend-username-input" class="input-field" placeholder="اكتب اسم المستخدم">
        <button class="btn btn-green" onclick="sendFriendRequest()">إرسال</button>
        <div id="request-status" class="status-message hidden"></div>
      </div>
      <div id="requests-panel" class="sidebar-panel hidden">
        <div class="panel-title">طلبات الصداقة</div>
        <div id="requests-list"></div>
      </div>
      <div class="friends-list">
        <div class="panel-title">الأصدقاء</div>
        <div id="friends-list"></div>
      </div>
    </div>
    <div class="chat-area" id="chat-area">
      <div id="empty-chat" class="empty-chat">
        <h2 style="font-size:36px;margin-bottom:15px;">V Chat</h2>
        <p style="color:#999;">اختر صديق للبدء في المحادثة</p>
      </div>
      <div id="active-chat" class="hidden" style="display:flex;flex-direction:column;flex:1;">
        <div class="chat-header">
          <img id="chat-friend-pic" src="" alt="Friend" class="profile-pic">
          <div>
            <div style="font-weight:bold;" id="chat-friend-name"></div>
            <div style="font-size:14px;" id="chat-friend-status"></div>
          </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-area">
          <div class="chat-input-form">
            <input type="text" id="message-input" class="chat-input" placeholder="اكتب رسالة...">
            <button class="btn-send" onclick="sendMessage()">➤</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// --- Firebase Setup ---
const firebaseConfig = {
  apiKey: "AIzaSyAb4-bpv8Il5NwnTSAJ9YitgyS9VtKGEDo",
  authDomain: "vchat-e61c5.firebaseapp.com",
  databaseURL: "https://vchat-e61c5-default-rtdb.firebaseio.com",
  projectId: "vchat-e61c5",
  storageBucket: "vchat-e61c5.firebasestorage.app",
  messagingSenderId: "1011250577212",
  appId: "1:1011250577212:web:a08e3d5d0f480b6db32839",
  measurementId: "G-D03R4FRGKQ"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// --- App State ---
let currentLanguage = 'ar';
let currentUser = null;
let allUsers = {};
let friendRequests = {};
let friends = {};
let messages = {};
let activeChat = null;

// --- Translations ---
const translations = {
  ar: {online:'متصل',offline:'غير متصل',selectFriend:'اختر صديق للبدء في المحادثة',noFriends:'لا يوجد أصدقاء',noRequests:'لا توجد طلبات',sent:'تم الإرسال',failed:'فشل! يرجى كتابة الاسم صحيح',fillFields:'يرجى ملء جميع الحقول',minAge:'الحد الأدنى للعمر هو 12 عام',passwordMismatch:'كلمات المرور غير متطابقة',userExists:'المستخدم موجود بالفعل',wrongCredentials:'اسم المستخدم أو كلمة المرور خاطئة'},
  en: {online:'Online',offline:'Offline',selectFriend:'Select a friend to start chatting',noFriends:'No friends yet',noRequests:'No requests',sent:'Sent',failed:'Failed! Please write the name correctly',fillFields:'Please fill all fields',minAge:'Minimum age is 12 years',passwordMismatch:'Passwords do not match',userExists:'User already exists',wrongCredentials:'Wrong username or password'}
};

function t(key) { return translations[currentLanguage][key]; }

// --- Online Status ---
async function updateOnlineStatus(isOnline) {
  if (!currentUser) return;
  const ref = database.ref('online/' + currentUser.uid);
  if (isOnline) {
    await ref.set(firebase.database.ServerValue.TIMESTAMP);
    ref.onDisconnect().remove();
  } else {
    await ref.remove();
  }
}

function isUserOnline(uid) {
  const lastSeen = allUsers[uid]?.lastSeen;
  return lastSeen && (Date.now() - lastSeen) < 10000;
}

// --- Auth Functions ---
async function createAccount() {
  const name = document.getElementById('create-name').value.trim();
  const age = document.getElementById('create-age').value;
  const password = document.getElementById('create-password').value;
  const confirm = document.getElementById('create-confirm-password').value;
  if (!name || !age || !password || !confirm) return alert(t('fillFields'));
  if (parseInt(age) < 12) return alert(t('minAge'));
  if (password !== confirm) return alert(t('passwordMismatch'));
  try {
    const email = name + '@vchat.fake';
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const uid = cred.user.uid;
    const data = {username:name,age:parseInt(age),gender:null,profilePic:''};
    await database.ref('users/'+uid).set(data);
    currentUser = {uid,...data};
    showScreen('gender');
  } catch (e) {
    alert(e.code === 'auth/email-already-in-use' ? t('userExists') : 'خطأ: ' + (e.message || 'حدث خطأ'));
  }
}

async function signIn() {
  const name = document.getElementById('signin-name').value.trim();
  const password = document.getElementById('signin-password').value;
  if (!name || !password) return alert(t('fillFields'));
  try {
    const email = name + '@vchat.fake';
    const cred = await auth.signInWithEmailAndPassword(email, password);
    const uid = cred.user.uid;
    const snap = await database.ref('users/'+uid).once('value');
    if (snap.exists()) {
      currentUser = {uid,...snap.val()};
      await updateOnlineStatus(true);
      showScreen('main');
      loadAllData();
      startRealtimeListener();
    } else alert('لم يتم العثور على بيانات المستخدم');
  } catch (e) {
    alert(t('wrongCredentials'));
  }
}

async function selectGender(gender) {
  const pic = gender === 'male'
    ? 'https://images.unsplash.com/photo-1529665253569-6d01c0eaf7b6?w=300'
    : 'https://images.unsplash.com/photo-1607167334063-459f8a1eb997?w=300';
  currentUser.gender = gender;
  currentUser.profilePic = pic;
  await database.ref('users/'+currentUser.uid).update({gender,profilePic:pic});
  await updateOnlineStatus(true);
  showScreen('main');
  loadAllData();
  startRealtimeListener();
}

// --- Data Loading ---
async function loadAllData() {
  try {
    const [u,r,f,m,o] = await Promise.all([
      database.ref('users').once('value'),
      database.ref('requests').once('value'),
      database.ref('friends').once('value'),
      database.ref('messages').once('value'),
      database.ref('online').once('value')
    ]);
    allUsers = u.val() || {};
    friendRequests = r.val() || {};
    friends = f.val() || {};
    messages = m.val() || {};
    const online = o.val() || {};
    Object.keys(allUsers).forEach(uid => allUsers[uid].lastSeen = online[uid] || 0);
    updateUI();
  } catch (e) { console.error(e); }
}

function startRealtimeListener() {
  database.ref().on('value', snap => {
    const d = snap.val() || {};
    allUsers = d.users || {};
    friendRequests = d.requests || {};
    friends = d.friends || {};
    messages = d.messages || {};
    const online = d.online || {};
    Object.keys(allUsers).forEach(uid => allUsers[uid].lastSeen = online[uid] || 0);
    if (currentUser) updateUI();
  });
}

// --- UI Helpers ---
function selectLanguage(lang) { currentLanguage = lang; document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr'; showScreen('sgn'); }
function showScreen(id) { document.querySelectorAll('.screen, .main-screen').forEach(s => s.classList.add('hidden')); document.getElementById('screen-'+id).classList.remove('hidden'); }
function showForgotPasswordModal() { document.getElementById('forgot-password-modal').classList.remove('hidden'); }
function closeForgotPasswordModal() { document.getElementById('forgot-password-modal').classList.add('hidden'); }
function toggleAddFriend() { const p=document.getElementById('add-friend-panel'),r=document.getElementById('requests-panel'); r.classList.add('hidden'); p.classList.toggle('hidden'); }
function toggleRequests() { const p=document.getElementById('requests-panel'),a=document.getElementById('add-friend-panel'); a.classList.add('hidden'); p.classList.toggle('hidden'); renderRequests(); }

// --- Friends & Messages ---
async function sendFriendRequest() {
  const username = document.getElementById('friend-username-input').value.trim();
  const status = document.getElementById('request-status');
  if (!username) return;
  const targetUid = Object.keys(allUsers).find(uid => allUsers[uid].username === username);
  if (!targetUid || targetUid === currentUser.uid) {
    status.textContent = t('failed'); status.className = 'status-message status-error'; status.classList.remove('hidden'); setTimeout(() => status.classList.add('hidden'), 3000);
    return;
  }
  if (!friendRequests[targetUid]) friendRequests[targetUid] = [];
  if (!friendRequests[targetUid].includes(currentUser.uid)) {
    friendRequests[targetUid].push(currentUser.uid);
    await database.ref('requests/'+targetUid).set(friendRequests[targetUid]);
  }
  status.textContent = t('sent'); status.className = 'status-message status-success'; status.classList.remove('hidden');
  setTimeout(() => { status.classList.add('hidden'); document.getElementById('friend-username-input').value = ''; }, 2000);
}

async function acceptRequest(uid) {
  const my = friends[currentUser.uid] || [], their = friends[uid] || [];
  if (!my.includes(uid)) my.push(uid);
  if (!their.includes(currentUser.uid)) their.push(currentUser.uid);
  await database.ref('friends/'+currentUser.uid).set(my);
  await database.ref('friends/'+uid).set(their);
  friendRequests[currentUser.uid] = (friendRequests[currentUser.uid] || []).filter(x => x !== uid);
  await database.ref('requests/'+currentUser.uid).set(friendRequests[currentUser.uid].length ? friendRequests[currentUser.uid] : null);
  updateUI();
}

async function rejectRequest(uid) {
  friendRequests[currentUser.uid] = (friendRequests[currentUser.uid] || []).filter(x => x !== uid);
  await database.ref('requests/'+currentUser.uid).set(friendRequests[currentUser.uid].length ? friendRequests[currentUser.uid] : null);
  updateUI();
}

function renderRequests() {
  const c = document.getElementById('requests-list'), r = friendRequests[currentUser.uid] || [], b = document.getElementById('requests-badge');
  if (r.length === 0) { c.innerHTML = '<div class="no-items">'+t('noRequests')+'</div>'; b.classList.add('hidden'); }
  else {
    b.textContent = r.length; b.classList.remove('hidden');
    c.innerHTML = r.map(uid => {
      const u = allUsers[uid];
      return u ? `<div class="request-item"><div class="request-user"><img src="${u.profilePic||'https://via.placeholder.com/40'}" class="request-pic" alt="${u.username}"><span>${u.username}</span></div><div style="display:flex;gap:8px;"><button class="btn-accept" onclick="acceptRequest('${uid}')">✓</button><button class="btn-reject" onclick="rejectRequest('${uid}')">✗</button></div></div>` : '';
    }).join('');
  }
}

function renderFriends() {
  const c = document.getElementById('friends-list'), f = friends[currentUser.uid] || [];
  if (f.length === 0) c.innerHTML = '<div class="no-items">'+t('noFriends')+'</div>';
  else c.innerHTML = f.map(uid => {
    const u = allUsers[uid];
    if (!u) return '';
    const online = isUserOnline(uid), active = activeChat === uid ? 'active' : '';
    return `<div class="friend-item ${active}" onclick="openChat('${uid}')"><img src="${u.profilePic||'https://via.placeholder.com/50'}" class="profile-pic" alt="${u.username}"><div style="flex:1;"><div style="font-weight:bold;">${u.username}</div><div style="font-size:14px;color:${online?'#0d6832':'#999999'};">${online?t('online'):t('offline')}</div></div></div>`;
  }).join('');
}

function openChat(uid) {
  activeChat = uid;
  document.getElementById('empty-chat').classList.add('hidden');
  document.getElementById('active-chat').classList.remove('hidden');
  const u = allUsers[uid];
  document.getElementById('chat-friend-pic').src = u.profilePic || 'https://via.placeholder.com/50';
  document.getElementById('chat-friend-name').textContent = u.username;
  const online = isUserOnline(uid), s = document.getElementById('chat-friend-status');
  s.textContent = online ? t('online') : t('offline');
  s.style.color = online ? '#0d6832' : '#999999';
  renderMessages(); renderFriends();
}

function renderMessages() {
  if (!activeChat) return;
  const id = [currentUser.uid, activeChat].sort().join('_'), msgs = messages[id] || [], c = document.getElementById('chat-messages');
  c.innerHTML = msgs.map(m => {
    const sent = m.senderUid === currentUser.uid;
    return `<div class="message ${sent?'message-sent':'message-received'}"><div class="message-content"><div>${m.text}</div><div class="message-time">${m.timestamp}</div></div></div>`;
  }).join('');
  c.scrollTop = c.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('message-input'), text = input.value.trim();
  if (!text || !activeChat) return;
  const id = [currentUser.uid, activeChat].sort().join('_'), now = new Date(), ts = now.toLocaleTimeString(currentLanguage==='ar'?'ar-EG':'en-US',{hour:'2-digit',minute:'2-digit'});
  await database.ref('messages/'+id).push({senderUid:currentUser.uid,text,timestamp:ts});
  input.value = '';
}

document.addEventListener('keypress', e => { if (e.key === 'Enter' && activeChat && document.activeElement === document.getElementById('message-input')) sendMessage(); });

function updateUI() {
  if (!currentUser) return;
  document.getElementById('header-profile-pic').src = currentUser.profilePic || 'https://via.placeholder.com/50';
  document.getElementById('header-username').textContent = currentUser.username;
  renderRequests(); renderFriends(); if (activeChat) renderMessages();
}

// --- Auth State ---
auth.onAuthStateChanged(async user => {
  if (user) {
    const uid = user.uid, snap = await database.ref('users/'+uid).once('value');
    if (snap.exists()) {
      currentUser = {uid,...snap.val()};
      await updateOnlineStatus(true);
      showScreen('main');
      loadAllData();
      startRealtimeListener();
    }
  } else showScreen('in');
});
</script>
</body>
</html>